/**
 * Mirako AI Video Generation Service
 * Supports text-to-video and image-to-video using Mirako AI
 */

export interface MirakoGenerationRequest {
    prompt: string;
    imageUrl?: string;
    aspectRatio?: '16:9' | '9:16' | '1:1' | '4:3';
    duration?: number;
    negativePrompt?: string;
}

export interface MirakoGenerationResponse {
    success: boolean;
    videoUrl?: string;
    error?: string;
    requestId?: string;
}

class MirakoService {
    private baseUrl: string = 'https://api.mirako.ai/v1';

    getApiKey(): string {
        try {
            const savedSettings = localStorage.getItem('ai_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.mirakoKey) return settings.mirakoKey.trim();
            }
        } catch {}

        const localKey = localStorage.getItem('mirako_api_key');
        if (localKey && localKey.trim()) {
            return localKey.trim();
        }

        const envKey = import.meta.env.VITE_MIRAKO_API_KEY;
        if (envKey && envKey !== 'your_mirako_key') return envKey.trim();
        
        // Provided by user
        return 'mi_FWR0uI66nLD5yiSt-KjlJvP7PyADve-ewc-i4qXfYJg';
    }

    setApiKey(key: string) {
        localStorage.setItem('mirako_api_key', key);
    }

    /**
     * Generate video using Mirako AI (Text-to-Video or Image-to-Video)
     */
    async generateVideo(request: MirakoGenerationRequest): Promise<MirakoGenerationResponse> {
        const apiKey = this.getApiKey();
        if (!apiKey) {
            return { success: false, error: 'Mirako API anahtarÄ± bulunamadÄ±.' };
        }

        try {
            console.log('ğŸ¬ Mirako AI video Ã¼retimi baÅŸlatÄ±lÄ±yor...');
            
            const endpoint = request.imageUrl ? '/video/async_generate_i2v' : '/video/async_generate_t2v';
            const fullUrl = `${this.baseUrl}${endpoint}`;
            
            console.log('DEBUG - Mirako URL:', fullUrl);
            console.log('DEBUG - Endpoint:', endpoint);
            
            const payload: any = {
                prompt: request.prompt,
                aspect_ratio: request.aspectRatio || '16:9',
                duration: request.duration || 5,
            };

            if (request.imageUrl) {
                payload.source_image_url = request.imageUrl;
            }

            if (request.negativePrompt) {
                payload.negative_prompt = request.negativePrompt;
            }

            const response = await fetch(fullUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Mirako HatasÄ±: ${errorData.message || response.status}`);
            }

            const data = await response.json();
            const taskId = data.task_id || data.id;

            if (!taskId) throw new Error('Mirako task ID alÄ±namadÄ±.');

            console.log('â³ Mirako videosu Ã¼retiliyor, Task ID:', taskId);

            // Poll for result
            return await this.pollStatus(taskId, apiKey);
        } catch (error: unknown) {
            console.error('âŒ Mirako video Ã¼retim hatasÄ±:', error);
            return {
                success: false,
                error: error instanceof Error ? error.message : 'Mirako video Ã¼retilemedi',
            };
        }
    }

    /**
     * Generate image using Mirako AI
     */
    async generateImage(request: { prompt: string, aspectRatio?: string }): Promise<MirakoGenerationResponse> {
        const apiKey = this.getApiKey();
        if (!apiKey) {
            return { success: false, error: 'Mirako API anahtarÄ± bulunamadÄ±.' };
        }

        try {
            console.log('ğŸ¨ Mirako AI gÃ¶rsel Ã¼retimi baÅŸlatÄ±lÄ±yor...');
            
            const response = await fetch(`${this.baseUrl}/image/async_generate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    prompt: request.prompt,
                    image_size: this.mapAspectRatio(request.aspectRatio || '1:1'),
                }),
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Mirako HatasÄ±: ${errorData.message || response.status}`);
            }

            const data = await response.json();
            const taskId = data.task_id || data.id;

            if (!taskId) throw new Error('Mirako task ID alÄ±namadÄ±.');

            console.log('â³ Mirako gÃ¶rseli Ã¼retiliyor, Task ID:', taskId);

            // Poll for result
            return await this.pollStatus(taskId, apiKey, 'image');
        } catch (error: unknown) {
            console.error('âŒ Mirako gÃ¶rsel Ã¼retim hatasÄ±:', error);
            return {
                success: false,
                error: error instanceof Error ? error.message : 'Mirako gÃ¶rsel Ã¼retilemedi',
            };
        }
    }

    private async pollStatus(taskId: string, apiKey: string, type: 'video' | 'image' = 'video', maxAttempts = 120): Promise<MirakoGenerationResponse> {
        let attempts = 0;
        const endpoint = type === 'video' ? `/video/task/${taskId}` : `/image/task/${taskId}`;
        
        while (attempts < maxAttempts) {
            try {
                const response = await fetch(`${this.baseUrl}${endpoint}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                if (response.ok) {
                    const statusData = await response.json();
                    const status = statusData.status?.toLowerCase();

                    if (status === 'completed' || status === 'succeeded') {
                        // More robust URL extraction
                        const videoUrl = statusData.video_url || 
                                       statusData.image_url || 
                                       statusData.result?.url || 
                                       statusData.result?.video_url ||
                                       (statusData.results && statusData.results[0]?.url) ||
                                       (statusData.results && statusData.results[0]?.video_url);

                        if (videoUrl) {
                            console.log('âœ… Mirako Ä°Ã§eriÄŸi HazÄ±r:', videoUrl);
                        } else {
                            console.warn('âš ï¸ Mirako tamamlandÄ± dedi ama URL bulunamadÄ±. Data:', statusData);
                        }

                        return {
                            success: !!videoUrl,
                            videoUrl: videoUrl,
                            error: videoUrl ? undefined : 'Ãœretim tamamlandÄ± ancak dosya adresi alÄ±namadÄ±.',
                            requestId: taskId
                        };
                    } else if (status === 'failed' || status === 'error') {
                        return {
                            success: false,
                            error: `Mirako Ã¼retimi baÅŸarÄ±sÄ±z: ${statusData.error_message || 'Bilinmeyen hata'}`,
                            requestId: taskId
                        };
                    }
                }
                
                await new Promise(resolve => setTimeout(resolve, 5000));
                attempts++;
                console.log(`ğŸ“Š Mirako ${type} durumu sorgulanÄ±yor (${attempts}/${maxAttempts})...`);
            } catch (error) {
                console.error('Mirako polling hatasÄ±:', error);
                await new Promise(resolve => setTimeout(resolve, 5000));
                attempts++;
            }
        }

        return { success: false, error: 'Mirako zaman aÅŸÄ±mÄ±.', requestId: taskId };
    }

    private mapAspectRatio(ratio: string): string {
        const ratioMap: Record<string, string> = {
            '1:1': 'square',
            '16:9': 'landscape',
            '9:16': 'portrait',
            '4:3': 'landscape_4_3'
        };
        return ratioMap[ratio] || 'square';
    }

    isConfigured(): boolean {
        return !!this.getApiKey();
    }
}

export const mirakoService = new MirakoService();
